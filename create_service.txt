CREATE DEFINER=`root`@`localhost` PROCEDURE `create_service`(
    IN templateID INT,
    IN newDateTime DATETIME,
    IN newTheme VARCHAR(255),
    IN newSongleader VARCHAR(255),
    OUT statusCode INT
)
BEGIN
    DECLARE existingService INT;
    DECLARE songleaderID INT;

    -- check date/time for existing service
    SELECT COUNT(*)
    INTO existingService
    FROM service
    WHERE Svc_DateTime = newDateTime;

    IF existingService > 0 THEN
        SET statusCode = 1;        -- service already exists
    ELSE

        -- insert new service
        INSERT INTO service (Svc_DateTime, Theme_Event)
        VALUES (newDateTime, newTheme);

        SET @newServiceID = LAST_INSERT_ID();


        -- get new songleader name if provided
        IF newSongleader IS NOT NULL AND newSongleader != '' THEN

            SELECT Person_ID
            INTO songleaderID
            FROM person
            WHERE CONCAT(First_Name, ' ', Last_Name) = newSongleader
            LIMIT 1;

            IF songleaderID IS NOT NULL THEN
                INSERT INTO fills_role (Service_ID, Person_ID, Role_Type, Confirmed)
                VALUES (@newServiceID, songleaderID, 'S', 'N');
            END IF;

        END IF;


        -- copy records into the new service
        INSERT INTO service_item
            (Service_ID, Seq_Num, Event_Type_ID, Title, Notes, Confirmed,
             Person_ID, Ensemble_ID, Song_ID)
        SELECT
            @newServiceID,      -- new Service_ID
            Seq_Num,
            Event_Type_ID,
            NULL AS Title,
            Notes,
            'N' AS Confirmed,
            NULL AS Person_ID,
            NULL AS Ensemble_ID,
            NULL AS Song_ID
        FROM service_item
        WHERE Service_ID = templateID;

        SET statusCode = 0;      -- success

    END IF;
END